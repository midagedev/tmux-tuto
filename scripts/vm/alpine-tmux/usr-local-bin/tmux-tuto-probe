#!/bin/sh

TMUXWEB_TMUX=0
if tmux -V >/dev/null 2>&1; then
  TMUXWEB_TMUX=1
fi

TMUXWEB_SESSION=-1
TMUXWEB_WINDOW=-1
TMUXWEB_PANE=-1
TMUXWEB_SCROLL=0
TMUXWEB_MODE=0
TMUXWEB_SESSION_NAME=""
TMUXWEB_WINDOW_NAME=""
TMUXWEB_ACTIVE_WINDOW=-1
TMUXWEB_LAYOUT=""
TMUXWEB_ZOOMED=0
TMUXWEB_SYNC=0
TMUXWEB_SEARCH=0
TMUXWEB_SEARCH_MATCHED=0

if [ "$TMUXWEB_TMUX" -eq 1 ]; then
  TMUXWEB_SESSION="$(tmux list-sessions 2>/dev/null | wc -l | tr -d ' ')"
  TMUXWEB_WINDOW="$(tmux list-windows -a 2>/dev/null | wc -l | tr -d ' ')"
  TMUXWEB_PANE="$(tmux list-panes -a 2>/dev/null | wc -l | tr -d ' ')"
  TMUXWEB_MODE="$(tmux display-message -p '#{?pane_in_mode,1,0}' 2>/dev/null || echo 0)"
  TMUXWEB_SCROLL="$(tmux display-message -p '#{?pane_in_mode,#{scroll_position},0}' 2>/dev/null | tr -d ' ')"
  case "$TMUXWEB_SCROLL" in
    ""|*[!0-9-]*)
      TMUXWEB_SCROLL=0
      ;;
  esac
  TMUXWEB_SESSION_NAME="$(tmux display-message -p '#S' 2>/dev/null | tr '\t\n\r' '   ')"
  TMUXWEB_WINDOW_NAME="$(tmux display-message -p '#W' 2>/dev/null | tr '\t\n\r' '   ')"
  TMUXWEB_ACTIVE_WINDOW="$(tmux display-message -p '#{window_index}' 2>/dev/null | tr -d ' ')"
  if [ -z "$TMUXWEB_ACTIVE_WINDOW" ]; then
    TMUXWEB_ACTIVE_WINDOW=-1
  fi
  TMUXWEB_LAYOUT="$(tmux display-message -p '#{window_layout}' 2>/dev/null | tr '\t\n\r' '   ')"
  TMUXWEB_ZOOMED="$(tmux display-message -p '#{window_zoomed_flag}' 2>/dev/null | tr -d ' ')"
  if [ -z "$TMUXWEB_ZOOMED" ]; then
    TMUXWEB_ZOOMED=0
  fi
  TMUXWEB_SYNC_RAW="$(tmux show-window-options -v synchronize-panes 2>/dev/null | tr -d '\n\r')"
  if [ "$TMUXWEB_SYNC_RAW" = "on" ]; then
    TMUXWEB_SYNC=1
  else
    TMUXWEB_SYNC=0
  fi

  if [ "$TMUXWEB_MODE" -eq 1 ]; then
    TMUXWEB_CURSOR_Y="$(tmux display-message -p '#{cursor_y}' 2>/dev/null | tr -d ' ')"
    TMUXWEB_PANE_HEIGHT="$(tmux display-message -p '#{pane_height}' 2>/dev/null | tr -d ' ')"
    case "$TMUXWEB_CURSOR_Y" in
      ""|*[!0-9-]*)
        TMUXWEB_CURSOR_Y=-1
        ;;
    esac
    case "$TMUXWEB_PANE_HEIGHT" in
      ""|*[!0-9-]*)
        TMUXWEB_PANE_HEIGHT=0
        ;;
    esac
    if [ "$TMUXWEB_CURSOR_Y" -ge 0 ] && [ "$TMUXWEB_PANE_HEIGHT" -gt 0 ]; then
      TMUXWEB_SCROLL_DERIVED=$((TMUXWEB_PANE_HEIGHT - 1 - TMUXWEB_CURSOR_Y))
      if [ "$TMUXWEB_SCROLL_DERIVED" -gt "$TMUXWEB_SCROLL" ]; then
        TMUXWEB_SCROLL=$TMUXWEB_SCROLL_DERIVED
      fi
    fi

    if [ "$TMUXWEB_SCROLL" -eq 0 ]; then
      TMUXWEB_HISTORY_SIZE="$(tmux display-message -p '#{history_size}' 2>/dev/null | tr -d ' ')"
      case "$TMUXWEB_HISTORY_SIZE" in
        ""|*[!0-9-]*)
          TMUXWEB_HISTORY_SIZE=0
          ;;
      esac
      if [ "$TMUXWEB_HISTORY_SIZE" -gt 0 ]; then
        TMUXWEB_SCROLL=1
      fi
    fi

    TMUXWEB_SEARCH=1
    TMUXWEB_SEARCH_MATCHED="$(tmux display-message -p '#{?search_present,1,0}' 2>/dev/null | tr -d ' ')"
    if [ -z "$TMUXWEB_SEARCH_MATCHED" ]; then
      TMUXWEB_SEARCH_MATCHED=0
    fi
  fi
fi

printf '[[TMUXWEB_STATE_V2:%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s\t%s]]\n' \
  "$TMUXWEB_TMUX" \
  "$TMUXWEB_SESSION" \
  "$TMUXWEB_WINDOW" \
  "$TMUXWEB_PANE" \
  "$TMUXWEB_SCROLL" \
  "$TMUXWEB_MODE" \
  "$TMUXWEB_SESSION_NAME" \
  "$TMUXWEB_WINDOW_NAME" \
  "$TMUXWEB_ACTIVE_WINDOW" \
  "$TMUXWEB_LAYOUT" \
  "$TMUXWEB_ZOOMED" \
  "$TMUXWEB_SYNC" \
  "$TMUXWEB_SEARCH" \
  "$TMUXWEB_SEARCH_MATCHED"
